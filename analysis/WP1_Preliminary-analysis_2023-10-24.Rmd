---
title: "PECATI | Preliminary data monitoring, cleaning, and analysis. October 2023"
author: "Daniel Alcala"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output: html_document
---

```{r, include = FALSE}
library(tidyverse)
library(readxl)
library(writexl)
library(janitor)
library(lubridate)
library(here)
library(cowplot)
library(gt)
library(gtsummary)
library(survival)
library(survminer)
library(epoxy)
library(crayon)

here("WP1_Preliminary-analysis_2023-10-24.Rmd")

cutoff_date <- as.Date("2023-10-24")
cutoff_date <- format(cutoff_date, "%Y_%m_%d")
```

# Patient Disposition
## Screening

```{r, message = FALSE, warning = FALSE, echo = FALSE}
data_00_screening <- read_excel(
    here(paste0("data/PECATI_ICF Screening_", cutoff_date, ".xlsx")),
    sheet = "ICF Screening",
    skip = 1) %>% 
  clean_names() %>% 
  rename(
    screening_date = "visit_date",
    eligibile = "is_the_patient_eligible_to_participate_in_the_study",
    sf_date = "non_eligible_date",
    sf_reason = "reason_not_eligible",
    eligibility_date_1 = "eligibility_date_v2",
    eligibility_date_2 = "eligibility_date_v3"
  ) %>% 
  mutate_at(
    vars(starts_with("eligibility_date")), dmy
  ) %>% 
  mutate(
    eligibility_date = if_else(
      eligibile == "Yes" & !is.na(eligibility_date_1), eligibility_date_1, eligibility_date_2),
    screening_date = dmy(screening_date),
    sf_date = dmy(sf_date),
    eligibility_date = ymd(eligibility_date)
  ) %>%
  select(
    patient, screening_date, eligibile, sf_date, sf_reason, eligibility_date
  )

screening_n <- length(data_00_screening$patient)
```

Listing of patients who have undergone the screening phase (n = `r screening_n`):

```{r, message = FALSE, warning = FALSE, echo = FALSE}
listing1_formatted_names <- c(
  "Patient",
  "Date of screening visit",
  "Eligible patient?",
  "Date of screening failure",
  "Reason for screening failure",
  "Date of confirmation of eligibility"
  )

data_00_screening_formatted <- data_00_screening %>% 
  set_names(listing1_formatted_names)

rmarkdown::paged_table(data_00_screening_formatted)
```

#### **Table 1. Patients included, excluded, and reasons for exclusion**

```{r, message = FALSE, warning = FALSE, echo = FALSE}
data_00_screening %>% 
  tbl_summary(
    include = c(eligibile, sf_reason),
    missing = "no",
    label = list(
      eligibile ~ "Included",
      sf_reason ~ "Excluded"
    )
  ) %>%
  modify_header(label = " ") %>%
  bold_labels()
```

## Intention-to-treat population (ITT)

```{r, message = FALSE, warning = FALSE, echo = FALSE}
data_01_cycles <- read_excel(
  here(paste0("data/PECATI_Cycles_", cutoff_date, ".xlsx")),
    sheet = "Cycles",
    skip = 1) %>% 
  clean_names()

data_02_itt <- data_01_cycles %>% filter(
  event_num == 1
  ) %>% 
  select(patient)

data_temp_itt <- merge(
  data_02_itt,
  data_00_screening,
  by = "patient",
  all = FALSE
  ) %>% 
  select(patient, screening_date, eligibility_date)

itt_n <- length(data_temp_itt$patient)
```

Listing of patients who have started study treatment (n = `r itt_n`):

```{r, message = FALSE, warning = FALSE, echo = FALSE}
listing2_formatted_names <- c(
  "Patient",
  "Date of screening visit",
  "Date of confirmation of eligibility"
  )

data_temp_itt_formatted <- data_temp_itt %>% 
  set_names(listing2_formatted_names)

rmarkdown::paged_table(data_temp_itt_formatted)
```

## Study treatment discontinuations (EoT)

```{r, message = FALSE, warning = FALSE, echo = FALSE}
data_03_icf <- read_excel(
  here(paste0("data/PECATI_ICF Screening_", cutoff_date, ".xlsx")),
    sheet = "ICF",
    skip = 1) %>% 
  clean_names() %>% 
  rename(icf_date = "date_consent_obtained") %>% 
  select(patient, icf_date) %>% 
  mutate(
    icf_date = dmy(icf_date)
    )

data_03_icf <- data_03_icf %>% 
  group_by(patient) %>% 
  filter(icf_date == min(icf_date)) %>% 
  ungroup()

data_temp_icf <- merge(
  data_temp_itt,
  data_03_icf,
  by = "patient",
  all = FALSE  
  )

data_04_c1d1 <- read_excel(
  here(paste0("data/PECATI_Cycles_", cutoff_date, ".xlsx")),
    sheet = "Cycles",
    skip = 1) %>% 
  clean_names() %>% 
  rename(
    c1d1_date = "visit_date"
  ) %>% 
  mutate(
    c1d1_date = dmy(c1d1_date)
    ) %>% 
  filter(
    event_num == 1
  ) %>% 
  select(
    patient, c1d1_date
  )

data_temp_c1d1 <- merge(
  data_temp_icf,
  data_04_c1d1,
  by = "patient",
  all = FALSE  
)

data_05_eot <- read_excel(
  here(paste0("data/PECATI_FU30-EOT_", cutoff_date, ".xlsx")),
    sheet = "FU30-EOT",
    skip = 1
  ) %>% 
  clean_names() %>% 
  rename(
    eot_reason = "main_reason_for_treatment_discontinuation",
    last_pembrolizumab_date = "date_of_last_dose_of_pembrolizumab",
    last_lenvatinib_date = "date_of_last_dose_of_lenvatinib",
    radiological_pd = "disease_progression_confirmed_by_recist_v1_1",
    radiological_pd_date = "date_of_radiologial_progressive_disease",
    clinical_pd = "clinical_progression_in_accordance_to_investigator_criteria",
    clinical_pd_date = "date_of_clinical_progressive_disease"
  ) %>% 
  mutate(
    discontinuation_date = dmy(discontinuation_date),
    last_pembrolizumab_date = dmy(last_pembrolizumab_date),
    last_lenvatinib_date = dmy(last_lenvatinib_date),
    radiological_pd_date = dmy(radiological_pd_date),
    clinical_pd_date = dmy(clinical_pd_date)
    ) %>% 
  # Manual fixes
  mutate(
    eot_reason = if_else(
      patient == "0102-004" & eot_reason == "Other", "Second primary esophageal cancer", eot_reason)
  ) %>% 
  select(
    patient, discontinuation_date, eot_reason, last_pembrolizumab_date,
    last_lenvatinib_date, radiological_pd, radiological_pd_date, clinical_pd,
    clinical_pd_date
    )

eot_n <- length(data_05_eot$patient)
```

Listing of patients who discontinued prematurely the study treatment (n = `r eot_n`):

```{r, message = FALSE, warning = FALSE, echo = FALSE}
listing3_formatted_names <- c(
  "Patient",
  "Date of end of treatment visit",
  "Reason for end of treatment",
  "Date of last dose of Pembrolizumab",
  "Date of last dose of Lenvantinib",
  "Radiological disease progression?",
  "Date of radiological disease progression",
  "Clinical disease progression?",
  "Date of clinical disease progression"
  )

data_05_eot_formatted <- data_05_eot %>% 
  set_names(listing3_formatted_names)

rmarkdown::paged_table(data_05_eot_formatted)
```


#### **Table 2. Patients who discontinued prematurely the study treatment:**

```{r, message = FALSE, warning = FALSE, echo = FALSE}
data_05_eot %>%
  tbl_summary(
    missing = "no",
    percent = "column",
    sort = list(everything() ~ "frequency"),
    label = list(eot_reason ~ "Reason for study treatment discontinuation"),
    include = c(eot_reason),
    missing_text = "Not reported"
  ) %>%
  modify_header(label = " ") %>%
  bold_labels()
```

## Study discontinuation (EoS)

```{r, message = FALSE, warning = FALSE, echo = FALSE}
# data_06_eos <- read_excel(
#   here(paste0("data/PECATI_End of Study_", cutoff_date, ".xlsx")),
#   sheet = "End of Study",
#   skip = 1
#   ) %>%
#   clean_names() %>%
#   rename(
#     eos_date = "eo_s_date",
#     eos_reason = "specify_the_reason",
#     exitus_reason = "principal_cause_of_death"
#   ) %>%
#   select(patient, eos_date, eos_reason, exitus_reason) %>%
#   # Manual fixes
#   mutate(
#     eos_date = dmy(eos_date),
#     eos_reason = if_else(
#       eos_reason == "Withdrawal of consent by subjectâ€™s request", "Withdrawal of consent", eos_reason),
#     eos_reason = if_else(
#       eos_reason == "Lost to follow-up", "Loss to follow-up", eos_reason)
#   )
# 
# data_temp_eos <- merge(
#   data_temp_eot,
#   data_06_eos,
#   by = "patient",
#   all = TRUE
# )
```

<!-- Listing of patients who discontinued prematurely the study treatment (n = `r eot_n`): -->

```{r, message = FALSE, warning = FALSE, echo = FALSE}
# rmarkdown::paged_table(data_temp_eos)
```

## Swimmer plot



