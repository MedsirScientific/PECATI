---
title: "PECATI | Preliminary data monitoring, cleaning, and analysis. February 2024"
author: "Daniel Alcala"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output: html_document
---

```{r, include = FALSE}
library(tidyverse)
library(readxl)
library(writexl)
library(janitor)
library(lubridate)
library(here)
library(cowplot)
library(gt)
library(gtsummary)
library(gtreg)
library(survival)
library(survminer)
library(epoxy)
library(crayon)
library(grid)
library(workflowr)
library(broom)

here("WP1_preliminary-analysis.Rmd")

project_id <- "PECATI"
cutoff_date <- as.Date("2024-02-09")
```

The data cutoff date for these analyses is: `r cutoff_date`

```{r, message = FALSE, warning = FALSE, echo = FALSE}
# Reformat the data cutoff date for reading of files
cutoff_date_formatted <- format(cutoff_date, "%Y_%m_%d")
```

# Patient Disposition

## Screening

```{r, message = FALSE, warning = FALSE, echo = FALSE, include = FALSE}
data_00_screening <- read_excel(
    here(paste0("data/", cutoff_date, "/", project_id, "_ICF Screening_", cutoff_date_formatted, ".xlsx")),
    sheet = "ICF Screening",
    skip = 1) %>% 
  clean_names()

# Print column names, excluding any columns that start with "inclusion_" or "exclusion_"
data_00_screening %>% 
  select(-starts_with("inclusion_"), -starts_with("exclusion_")) %>% 
  names()
```

```{r, message = FALSE, warning = FALSE, echo = FALSE}
rename_list = list(
  patient = "patient",
  screening_date = "visit_date",
  eligible = "is_the_patient_eligible_to_participate_in_the_study",
  sf_date = "non_eligible_date",
  sf_reason = "reason_not_eligible",
  eligibility_date_1 = "eligibility_date_v2",
  eligibility_date_2 = "eligibility_date_v3"
  )

data_00_screening <- read_excel(
    here(paste0("data/", cutoff_date, "/", project_id, "_ICF Screening_", cutoff_date_formatted, ".xlsx")),
    sheet = "ICF Screening",
    skip = 1) %>% 
  clean_names() %>% 
  rename(
    !!!rename_list
  ) %>% 
  mutate_at(
    vars(starts_with("eligibility_date")), dmy
  ) %>% 
  mutate(
    eligibility_date = if_else(
      eligible == "Yes" & !is.na(eligibility_date_1), eligibility_date_1, eligibility_date_2),
    eligibility_date = ymd(eligibility_date),
    sf_date = dmy(sf_date),
    ### Manual fixes ### ------------------------------------------------------
    eligible = if_else(
      patient == "0301-014", "Yes", eligible),
    eligible = if_else(
      patient == "0301-012", "Yes", eligible),
    ### -----------------------------------------------------------------------
    sf_reason = if_else(
      is.na(eligible), "Unknown", sf_reason),
    screening_date = dmy(screening_date)
  ) %>%
  select(
    patient, screening_date, eligible, sf_date, sf_reason, eligibility_date
  )

### Manual fix ### ------------------------------------------------------------
# Change eligibility_date for patient 0301-014 to screening_date
data_00_screening$eligibility_date[which(data_00_screening$patient == "0301-014")] <- data_00_screening$screening_date[which(data_00_screening$patient == "0301-014")]
```

```{r, message = FALSE, warning = FALSE, echo = FALSE}

screening_n <- length(data_00_screening$patient)
```

Listing of patients who have undergone the screening phase (n = `r screening_n`):

```{r, message = FALSE, warning = FALSE, echo = FALSE}
listing1_formatted_names <- c(
  "Patient",
  "Date of screening visit",
  "Eligible patient?",
  "Date of screening failure",
  "Reason for screening failure",
  "Date of confirmation of eligibility"
  )

data_00_screening_formatted <- data_00_screening %>% 
  set_names(listing1_formatted_names)

rmarkdown::paged_table(data_00_screening_formatted)
```

#### **Table 1. Patients included, excluded, and reasons for exclusion**

```{r, message = FALSE, warning = FALSE, echo = FALSE}
data_00_screening %>% 
  tbl_summary(
    include = c(eligible, sf_reason),
    missing = "no",
    label = list(
      eligible ~ "Included",
      sf_reason ~ "Excluded"
    )
  ) %>%
  modify_header(label = " ") %>%
  bold_labels()
```

## Intention-to-treat population (ITT)

```{r, message = FALSE, warning = FALSE, echo = FALSE}
data_01_cycles <- read_excel(
  here(paste0("data/", cutoff_date, "/", project_id, "_Cycles_", cutoff_date_formatted, ".xlsx")),
    sheet = "Cycles",
    skip = 1) %>% 
  clean_names()

data_02_itt <- data_01_cycles %>% filter(
  event_num == 1
  ) %>% 
  select(patient)

data_temp_itt <- merge(
  data_02_itt,
  data_00_screening,
  by = "patient",
  all = FALSE
  ) %>% 
  select(patient, screening_date, eligibility_date)

itt_n <- length(data_temp_itt$patient)
```

Listing of patients who have started study treatment (n = `r itt_n`):

```{r, message = FALSE, warning = FALSE, echo = FALSE}
listing2_formatted_names <- c(
  "Patient",
  "Date of screening visit",
  "Date of confirmation of eligibility"
  )

data_temp_itt_formatted <- data_temp_itt %>% 
  set_names(listing2_formatted_names)

rmarkdown::paged_table(data_temp_itt_formatted)
```

## Study treatment discontinuation (EoT)

```{r, message = FALSE, warning = FALSE, echo = FALSE}
data_03_icf <- read_excel(
  here(paste0("data/", cutoff_date, "/", project_id, "_ICF Screening_", cutoff_date_formatted, ".xlsx")),
    sheet = "ICF",
    skip = 1) %>% 
  clean_names() %>% 
  rename(icf_date = "date_consent_obtained") %>% 
  select(patient, icf_date) %>% 
  mutate(
    icf_date = dmy(icf_date)
    )

### Manual fix ### ------------------------------------------------------------
# Add patient 0301-014 who was included recently and doesn't appear in the ICF sheet
# I'm using one day before the screening visit date as the date of ICF
data_03_icf <- rbind(
  data_03_icf,
  data.frame(patient = "0301-014", icf_date = as.Date("2024-01-21"))
  )
### ---------------------------------------------------------------------------

data_03_icf <- data_03_icf %>% 
  group_by(patient) %>% 
  filter(icf_date == min(icf_date)) %>% 
  ungroup()

data_temp_icf <- merge(
  data_temp_itt,
  data_03_icf,
  by = "patient",
  all = FALSE  
  )

data_04_c1d1 <- read_excel(
  here(paste0("data/", cutoff_date, "/", project_id, "_Cycles_", cutoff_date_formatted, ".xlsx")),
    sheet = "Cycles",
    skip = 1) %>% 
  clean_names() %>% 
  rename(
    c1d1_date = "visit_date"
  ) %>% 
  mutate(
    c1d1_date = dmy(c1d1_date)
    ) %>% 
  filter(
    event_num == 1
  ) %>% 
  select(
    patient, c1d1_date
  )

data_temp_c1d1 <- merge(
  data_temp_icf,
  data_04_c1d1,
  by = "patient",
  all = FALSE
)

data_05_eot <- read_excel(
  here(paste0("data/", cutoff_date, "/", project_id, "_FU30-EOT_", cutoff_date_formatted, ".xlsx")),
    sheet = "FU30-EOT",
    skip = 1
  ) %>% 
  clean_names() %>% 
  rename(
    eot_reason = "main_reason_for_treatment_discontinuation",
    last_pembrolizumab_date = "date_of_last_dose_of_pembrolizumab",
    last_lenvatinib_date = "date_of_last_dose_of_lenvatinib",
    radiological_pd = "disease_progression_confirmed_by_recist_v1_1",
    radiological_pd_date = "date_of_radiologial_progressive_disease",
    clinical_pd = "clinical_progression_in_accordance_to_investigator_criteria",
    clinical_pd_date = "date_of_clinical_progressive_disease"
  ) %>% 
  mutate(
    discontinuation_date = dmy(discontinuation_date),
    last_pembrolizumab_date = dmy(last_pembrolizumab_date),
    last_lenvatinib_date = dmy(last_lenvatinib_date),
    radiological_pd_date = dmy(radiological_pd_date),
    clinical_pd_date = dmy(clinical_pd_date)
    ) %>% 
  ### Manual fixes ### --------------------------------------------------------
  mutate(
    eot_reason = if_else(
      eot_reason == "Death (fill “End of Study” form)", "Exitus", eot_reason),
    eot_reason = if_else(
      patient == "0102-004" & eot_reason == "Other", "Second primary esophageal cancer", eot_reason),
    eot_reason = if_else(
      eot_reason == "General or specific changes in the patient’s condition render the patient unacceptable for further treatment in the judgment of the Investigator", "Investigator's decision", eot_reason)
  ### -------------------------------------------------------------------------
  ) %>% 
  select(
    patient, discontinuation_date, eot_reason, last_pembrolizumab_date,
    last_lenvatinib_date, radiological_pd, radiological_pd_date, clinical_pd,
    clinical_pd_date
    )

data_temp_eot <- merge(
  data_temp_c1d1,
  data_05_eot,
  by = "patient",
  all = TRUE
  )

eot_n <- length(data_05_eot$patient)
```

Listing of patients who discontinued prematurely the study treatment (n = `r eot_n`):

```{r, message = FALSE, warning = FALSE, echo = FALSE}
listing3_formatted_names <- c(
  "Patient",
  "Date of end of treatment visit",
  "Reason for end of treatment",
  "Date of last dose of Pembrolizumab",
  "Date of last dose of Lenvantinib",
  "Radiological disease progression?",
  "Date of radiological disease progression",
  "Clinical disease progression?",
  "Date of clinical disease progression"
  )

data_05_eot_formatted <- data_05_eot %>% 
  set_names(listing3_formatted_names)

rmarkdown::paged_table(data_05_eot_formatted)
```

#### **Table 2. Patients who discontinued prematurely the study treatment:**

```{r, message = FALSE, warning = FALSE, echo = FALSE}
data_05_eot %>%
  tbl_summary(
    missing = "no",
    percent = "column",
    sort = list(everything() ~ "frequency"),
    label = list(eot_reason ~ "Reason for study treatment discontinuation"),
    include = c(eot_reason),
    missing_text = "Not reported"
  ) %>%
  modify_header(label = " ") %>%
  bold_labels()
```

## Study discontinuation (EoS)

```{r, message = FALSE, warning = FALSE, echo = FALSE}
data_06_eos <- read_excel(
  here(paste0("data/", cutoff_date, "/", project_id, "_End of Study_", cutoff_date_formatted, ".xlsx")),
  sheet = "End of Study",
  skip = 1
  ) %>%
  clean_names() %>%
  rename(
    eos = "has_the_patient_continued_the_follow_up_until_the_eo_s_date",
    eos_date = "eo_s_date",
    eos_reason = "end_of_study_follow_up_main_reason",
    exitus_reason = "principal_cause_of_death"
  ) %>%
  select(patient, eos, eos_date, eos_reason, exitus_reason) %>%
  mutate(
    eos_date = dmy(eos_date),
    ### Manual fixes ### ------------------------------------------------------
    eos_reason = if_else(
      eos_reason == "Death", "Exitus", eos_reason),
    exitus_reason = if_else(
      patient == "0102-003", "Disease progression", exitus_reason),
    exitus_reason = if_else(
      patient == "0202-002", "Disease progression", exitus_reason),
    exitus_reason = if_else(
      patient == "0202-003", "Disease progression", exitus_reason),
    exitus_reason = if_else(
      patient == "0301-005", "Disease progression", exitus_reason),
    exitus_reason = if_else(
      patient == "0301-002", "Myocardial ischaemia", exitus_reason)
  )

data_temp_eos <- merge(
  data_temp_eot,
  data_06_eos,
  by = "patient",
  all = TRUE
)

eos_n <- length(data_06_eos$patient)
```

Listing of patients who discontinued the study (n = `r eos_n`):

```{r, message = FALSE, warning = FALSE, echo = FALSE}
listing4_formatted_names <- c(
  "Patient",
  "Did the patient complete the study?",
  "Date of end of study",
  "Resason for premature end of study",
  "Main reason for exitus"
  )

data_06_eos_formatted <- data_06_eos %>% 
  set_names(listing4_formatted_names)

rmarkdown::paged_table(data_06_eos_formatted)
```

#### **Table 3. Patients who discontinued prematurely the study:**

```{r, message = FALSE, warning = FALSE, echo = FALSE}
data_06_eos_formatted %>%
  tbl_summary(
    missing = "no",
    percent = "column",
    sort = list(everything() ~ "frequency"),
    label = list("Resason for premature end of study" ~ "Premature study discontinuation",
                 "Did the patient complete the study?" ~ "Study completion"),
    include = c("Did the patient complete the study?", "Resason for premature end of study",
                "Main reason for exitus"),
    missing_text = "Not reported"
  ) %>%
  modify_header(label = " ") %>%
  bold_labels()
```

## Swimmer plot

```{r, message = FALSE, warning = FALSE, echo = FALSE}
data_temp_eos <- data_temp_eos %>% 
  mutate(
    exitus = if_else(
      eos_reason == "Exitus", eos_date, as.Date(NA_real_)),
    progression = if_else(
      radiological_pd == "Yes", discontinuation_date, as.Date(NA_real_)),
    progression = if_else(
      clinical_pd == "Yes", discontinuation_date, as.Date(NA_real_))
  )

### Manual fix ### ------------------------------------------------------------
# Change progression for patient 0202-005 to radiological_pd_date
data_temp_eos$progression[which(data_temp_eos$patient == "0202-005")] <- data_temp_eos$radiological_pd_date[which(data_temp_eos$patient == "0202-005")]
### ---------------------------------------------------------------------------

# Fill the NAs in the eos_date column with today's date
data_temp_eos$eos_date <- if_else(
  is.na(data_temp_eos$eos_date), cutoff_date, data_temp_eos$eos_date)

# Get the earliest date across columns for each patient and make it a date column
data_temp_eos$earliest_date <- apply(data_temp_eos[, sapply(data_temp_eos, is.Date)], 1, min, na.rm = TRUE)

# Get the latest date across columns for each patient and make it a date column
data_temp_eos$latest_date <- apply(data_temp_eos[, sapply(data_temp_eos, is.Date)], 1, max, na.rm = TRUE)

# Create a row for each patient for each day from the earliest to the latest date
data_07_swimmer_long <- data_temp_eos %>%
  mutate(
    earliest_date = ymd(earliest_date),
    latest_date = ymd(latest_date)
  ) %>% 
  rowwise() %>%
  mutate(study_day = list(seq.Date(from = earliest_date, to = latest_date, by = "day"))) %>%
  unnest(study_day)

# Count the number of rows for each patient
data_07_swimmer_long <- data_07_swimmer_long %>%
  group_by(patient) %>%
  mutate(event_num = row_number())

data_07_swimmer_long <- data_07_swimmer_long %>% 
  mutate(
    month = event_num * 0.0328767
  )

data_07_swimmer_long$icf_this_day <- ifelse(
  data_07_swimmer_long$icf_date == data_07_swimmer_long$study_day, data_07_swimmer_long$month, NA
  )

data_07_swimmer_long$c1d1_this_day <- ifelse(
  data_07_swimmer_long$c1d1_date == data_07_swimmer_long$study_day, data_07_swimmer_long$month, NA
  )

data_07_swimmer_long$pd_this_day <- ifelse(
  data_07_swimmer_long$progression == data_07_swimmer_long$study_day, data_07_swimmer_long$month, NA
  )

data_07_swimmer_long$exitus_this_day <- ifelse(
  data_07_swimmer_long$exitus == data_07_swimmer_long$study_day, data_07_swimmer_long$month, NA
  )

data_07_swimmer_long <- data_07_swimmer_long %>% 
  group_by(patient) %>% 
  mutate(max_day = max(event_num)) %>% 
  ungroup() %>% 
  mutate(patient = fct_reorder(factor(patient), max_day))
```

#### **Figure 1. Patient trajectories along the clinical trial from informed consent to study termination**

```{r, swimmer-plot-patient-disposition, fig.height = 8, message = FALSE, warning = FALSE, echo = FALSE}
cols <- c(
  "Study treatment start date" = "#74AAFF",
  "Disease progression" = "#FFD966",
  "Exitus" = "#040404"
)

shape_override <- c(21, 21, 21)
stroke_override <- c(1, 1, 1)
size_override <-  c(2, 2, 2)

swimmer <- data_07_swimmer_long %>%
  ggplot(
    aes(y = patient, group = patient)) +
  theme_bw() + 
  theme(
    panel.grid.minor.x = element_blank(),
    panel.border = element_blank()
  ) +
  # 1 data layer: line plot showing number of TAs
  geom_line(aes(x = month), linewidth = 2.5, color = "#9A99A0", alpha = 0.25) +
  # 2 data layer: dot plot showing when the ICF was signed
  geom_point(aes(x = icf_this_day),
             size = 2.5,
             stroke = 0.5,
             shape = 21,
             color = "#74AAFF",
             fill = "#74AAFF",
             alpha = 0.65) +
  # 3 data layer: dot plot showing the study treatment start date
  geom_point(aes(x = c1d1_this_day),
             size = 2.5,
             stroke = 0.5,
             shape = 1,
             color = "#74AAFF") +
  # 4 data layer: dot plot showing whether disease progression
  geom_point(aes(x = pd_this_day),
             size = 2.5,
             stroke = 0.5,
             shape = 21,
             color = "#040404",
             fill = "#FFD966",
             alpha = 0.95) +
  # 5 data layer: dot plot showing TAs with an OR = SD
  geom_point(aes(x = exitus_this_day),
             size = 2.5,
             stroke = 0.5,
             shape = 21,
             color = "#040404",
             fill = "#040404") +
  # Final aesthetics adjustments
  scale_color_manual(values = cols,
                     name = "XXXX") +
  scale_x_continuous(breaks = seq(0, 36, 5)) +
  guides(color = guide_legend(
  override.aes = list(
    shape = shape_override,
    stroke = stroke_override,
    size = size_override
  )
)) +
  labs(
    x = "Time since ICF sign (months)",
    y = "Patient"
  ) +
  theme(panel.grid.major.y = element_blank())

ggsave(
  paste("../output/", project_id, "_swimmer-plot_patient-disposition_", as.Date(Sys.Date()), ".png", sep = ""),
  swimmer,
  width = 2048,
  height = 4096,
  units = "px",
  dpi = 300
  )

swimmer
```

Blue filled circles represent the date of informed consent. Blue empty circles represent the date of study treatment start. Yellow filled circles represent the date of disease progression. Black filled circles represent the date of exitus.

# Tumour Assessment

This section presents the cleaning of tumour assessment data from the PECATI study. The ultimate goal is to obtain the number of patients who have experienced radiological disease progression. However, the main purpose of this preliminary analysis of radiological progressions is to detect anomalies or discrepancies in the tumour assessment data collected.

Data from tumour assessments need to be pulled from two different sources. On the one hand, we have the baseline tumour assessment included in the Screening sheet. On the other hand, we have the tumour assessment sheet itself, which collects all post-baseline assessments.

In addition, some patients might not have measurable lesions at baseline. Therefore, we need to collect data for both types of lesions.

## Baseline tumor assessment

### Measurable disease

First, we extract data from patients with measurable lesions at baseline:

```{r, message = FALSE, warning = FALSE, echo = FALSE}
data_08a_baseline_target <- read_excel(
    here(paste0("data/", cutoff_date, "/", project_id, "_ICF Screening_", cutoff_date_formatted, ".xlsx")),
    sheet = "TARGET",
    skip = 1) %>% 
    clean_names() %>% 
    # The variable "event_num" encodes the tumour assessment number in the post-baseline assessments.
    # Create this variable and assign a 0 to mark these data as the baseline assessment.
    mutate(
      event_num = 0
    ) %>%
    group_by(patient, event_num) %>%
    # We collect the length of the longest diameter of each reported target (i.e., measurable) lesion individually.
    # Calculate the sum of longest diameter of all lesions.
    mutate(
      sum_of_lesions = sum(longest_diameter_short_axis_mm)
    ) %>%
    # Since we now have the sum of longest diameters repeated as many times as there are measurable lesions, we can keep either any row
    group_by(patient) %>%
    filter(row_number() == 1) %>%
    mutate(
      evaluation_date = dmy(evaluation_date)
    ) %>% 
    # Create a dummy variable to code that the patient had measurable disease at baseline.
    mutate(
      baseline_target = 0
    ) %>% 
    select(
        patient, event_num, baseline_target, evaluation_date, sum_of_lesions
        )

data_08a_baseline_target <- merge(
  data_02_itt,
  data_08a_baseline_target,
  by = "patient",
  all = FALSE
)

baseline_target_n <- length(data_08a_baseline_target$patient)
```

Listing of patients with measurable disease at baseline phase (n = `r baseline_target_n`):

```{r, message = FALSE, warning = FALSE, echo = FALSE}
listing5_formatted_names <- c(
  "Patient",
  "Date of baseline tumor assessment",
  "Sum of longest diameters (SLDs)"
  )

data_08a_baseline_target_formatted <- data_08a_baseline_target %>% 
  select(patient, evaluation_date, sum_of_lesions) %>% 
  set_names(listing5_formatted_names)
  
rmarkdown::paged_table(data_08a_baseline_target_formatted)
```

### Non-measurable disease

Then, we extract data from non-measurable lesions at baseline for all patients:

```{r, message = FALSE, warning = FALSE, echo = FALSE}
data_08b_baseline_nontarget <- read_excel(
    here(paste0("data/", cutoff_date, "/", project_id, "_ICF Screening_", cutoff_date_formatted, ".xlsx")),
    sheet = "NON_TARGET",
    skip = 1) %>% 
    clean_names() %>% 
    # The variable "event_num" encodes the tumour assessment number in the post-baseline assessments.
    # Create this variable and assign a 0 to mark this as the baseline assessment.
    mutate(
      event_num = 0
    ) %>%
    # Since we only care about the number of patients with non-measurable disease at baseline, we can keep either any row
    group_by(patient) %>%
    filter(row_number() == 1) %>%
    mutate(
      evaluation_date = dmy(evaluation_date)
    ) %>% 
    select(
      patient, event_num, evaluation_date
    )

data_08b_baseline_nontarget <- merge(
  data_02_itt,
  data_08b_baseline_nontarget,
  by = "patient",
  all = FALSE
)

baseline_nontarget_n <- length(data_08b_baseline_nontarget$patient)
```

Listing of patients with measurable disease at baseline phase (n = `r baseline_nontarget_n`):

```{r, message = FALSE, warning = FALSE, echo = FALSE}
listing6_formatted_names <- c(
  "Patient",
  "Date of baseline tumor assessment"
  )

data_08b_baseline_nontarget_formatted <- data_08b_baseline_nontarget %>% 
  select(patient, evaluation_date) %>% 
  set_names(listing6_formatted_names)

rmarkdown::paged_table(data_08b_baseline_nontarget_formatted)
```

```{r, message = FALSE, warning = FALSE, echo = FALSE}
data_08_baseline_all <- full_join(
  data_08a_baseline_target,
  data_08b_baseline_nontarget,
  by = c("patient", "event_num")
  ) %>%
  # If a patient had measurable lesions at baseline, we want to keep that data.
  # Only if there were no measurable lesions, we want to keep the tumour assessment date when the non-measurable lesions were detected.
  mutate(
    evaluation_date = if_else(
      is.na(evaluation_date.x), evaluation_date.y, evaluation_date.x
    )
  ) %>%
  # The following mutate() function creates a "baseline_nontarget" variable that codes 0 if the patient had no measurable lesions at baseline.
  mutate(
    baseline_nontarget = if_else(is.na(baseline_target) == 0, 1, 0),
    baseline_nontarget = na_if(baseline_nontarget, 1)
  ) %>% 
  select(
    patient, event_num, evaluation_date, baseline_target, sum_of_lesions, baseline_nontarget
  )
```

### Quality assurance of baseline tumor burden

A histogram with the sum of the longest diameters of each patient at baseline is presented below with the intention of detecting possible strange or unlikely patterns:

```{r baseline-sld-histogram, message = FALSE, warning = FALSE, echo = FALSE}
ggplot(
  data_08_baseline_all, 
  aes(x = sum_of_lesions)) +
  geom_histogram(
    fill = "#F3656C", 
    alpha = 0.5, 
    color = "#F3656C",
    bins = 54) +
  theme(
    panel.background = element_rect(fill = "#FFFFFF", colour = "#FFFFFF"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.background  = element_rect(fill = "#FFFFFF", colour = "#FFFFFF")
  ) +
  labs(
    x = "Sum of longest diameters at baseline (mm)",
    y = "Number of patients"
  )
```

## Post-baseline tumor assessment

### Quality assurance of post-baseline tumor burden

Similarly, a histogram with the sum of the longest diameters of each patient after baseline is presented below with the intention of detecting possible strange or unlikely patterns:

```{r post-baseline-sld-histogram, message = FALSE, warning = FALSE, echo = FALSE}
data_09a_postbaseline_target <- read_excel(
  here(paste0("data/", cutoff_date, "/", project_id, "_Tumor Assessment_", cutoff_date_formatted, ".xlsx")),
    sheet = "TARGET",
    skip = 1) %>% 
    clean_names() %>%
    # We collect the length of the longest diameter of each reported target (i.e., measurable) lesion individually.
    # Calculate the sum of longest diameter of all lesions for each tumour assessment.
    group_by(patient, event_num) %>%
    mutate(
      sum_of_lesions = sum(longest_diameter_short_axis_mm)
    ) %>%
    # Since we now have the sum of longest diameters repeated as many times as there are measurable lesions, we can keep either any row
    group_by(patient, event_num) %>%
    filter(row_number() == 1) %>%
    mutate(
      evaluation_date = dmy(evaluation_date)
    ) %>% 
    select(
      patient, event_num, evaluation_date, sum_of_lesions
    )

data_09b_postbaseline_nontarget <- read_excel(
    here(paste0("data/", cutoff_date, "/", project_id, "_Tumor Assessment_", cutoff_date_formatted, ".xlsx")),
    sheet = "NON_TARGET",
    skip = 1) %>% 
    clean_names() %>%
    # Since we now have the sum of longest diameters repeated as many times as there are measurable lesions, we can keep either any row
    group_by(patient, event_num) %>%
    filter(row_number() == 1) %>%
    mutate(
      evaluation_date = dmy(evaluation_date)
    ) %>% 
    select(
      patient, event_num, evaluation_date
    )

data_09_postbaseline <- merge(
  data_09a_postbaseline_target,
  data_09b_postbaseline_nontarget,
  by = c("patient", "event_num", "evaluation_date"),
  all = TRUE
)

# Manual fix
data_09_postbaseline <- data_09_postbaseline[!(data_09_postbaseline$patient == '0204-001' & is.na(data_09_postbaseline$sum_of_lesions)), ]

ggplot(
  data_09_postbaseline, 
  aes(x = sum_of_lesions)) +
  geom_histogram(
    fill = "#6561FF", 
    alpha = 0.5, 
    color = "#6561FF",
    bins = 54) +
  theme(
    panel.background = element_rect(fill = "#FFFFFF", colour = "#FFFFFF"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.background  = element_rect(fill = "#FFFFFF", colour = "#FFFFFF")
  ) +
  labs(
    x = "Sum of longest diameters after baseline (mm)",
    y = "Number of assessments"
  )
```

```{r, message = FALSE, warning = FALSE, echo = FALSE}
data_10_new_lesions <- read_excel(
    here(paste0("data/", cutoff_date, "/", project_id, "_Tumor Assessment_", cutoff_date_formatted, ".xlsx")),
    sheet = "NEW_LESIONS",
    skip = 1) %>% 
    clean_names() %>% 
    # Create a new variable that encodes whether the patient had a new lesion at any tumour assessment
    mutate(
      new_lesions = "Yes"
    ) %>% 
    mutate(
      evaluation_date = dmy(evaluation_date)
    ) %>% 
    # Since the presentation of a single new lesion already implies disease progression, we only keep the record of one new lesion, regardless of which one.
    group_by(patient) %>%
    filter(row_number() == 1) %>% 
    select(
      patient, event_num, evaluation_date, new_lesions
    )

data_11_recist <- read_excel(
    here(paste0("data/", cutoff_date, "/", project_id, "_Tumor Assessment_", cutoff_date_formatted, ".xlsx")),
    sheet = "Tumor Assessment",
    skip = 1) %>% 
    clean_names() %>% 
    select(
      patient, event_num, target_lesions_response, non_target_lesions_response, overall_response
      )

data_12_or_recist <- merge(
    data_08_baseline_all,
    data_09_postbaseline,
    by = c("patient", "event_num", "evaluation_date","sum_of_lesions"),
    all = TRUE
    ) %>% 
    # We create a new variable with the sum of lesion diameters at baseline to later calculate the change from baseline.
    group_by(patient) %>%
    mutate(
  # Manual fix ###########################
      # sum_of_lesions = if_else(
      #   patient == "0107-007" & event_num == 0, 22.2, sum_of_lesions),
      # sum_of_lesions = if_else(
      #   patient == "0107-008" & event_num == 0, 41, sum_of_lesions),
      baseline_sld = sum_of_lesions[event_num == 0]
      ) %>%
    mutate(
      change_from_baseline = sum_of_lesions - baseline_sld
    ) %>%
    mutate(
      percent_change_from_baseline = ((sum_of_lesions - baseline_sld) / baseline_sld) * 100
    ) %>% 
    # For coding disease progression, RECIST sets the criterion of an increase of at least 20% with respect to the smallest sum of lesion diameters (nadir).
    group_by(patient) %>%
    mutate(
      nadir = ifelse(event_num == 0, sum_of_lesions, pmin(sum_of_lesions, lag(sum_of_lesions)))
    ) %>%
    mutate(
      change_from_nadir = sum_of_lesions - nadir
    ) %>%
    mutate(
      percent_change_from_nadir = ((sum_of_lesions - nadir) / nadir) * 100
    )

data_12_or_recist <- data_12_or_recist[!(data_12_or_recist$patient == '0301-007' & is.na(data_12_or_recist$sum_of_lesions)), ]

data_12_or_recist <- merge(
  data_12_or_recist,
  data_10_new_lesions,
  by = c("patient", "event_num", "evaluation_date"),
  all = TRUE
) %>% 
  mutate(
    new_lesions = if_else(
      is.na(new_lesions), "No", new_lesions
    )
  )

data_12_or_recist <- merge(
  data_12_or_recist,
  data_11_recist,
  by = c("patient", "event_num"),
  all = TRUE
) %>%
  filter(
    !is.na(evaluation_date)
    ) %>% 
  mutate(
    overall_response = if_else(
      overall_response == "Progressive Disease (PD)", "PD", overall_response),
    overall_response = if_else(
      overall_response == "Complete Response (CR)", "CR", overall_response),
    overall_response = if_else(
      overall_response == "Partial Response (PR)", "PR", overall_response),
    overall_response = if_else(
      overall_response == "Stable Disease (SD)", "SD", overall_response),
    overall_response = if_else(
      overall_response == "Non-CR/Non-PD", "Non-CR/Non-PD", overall_response),
    PD = if_else(overall_response == "PD", 1, 0),
    CR = if_else(overall_response == "CR", 1, 0),
    PR = if_else(overall_response == "PR", 1, 0),
    SD = if_else(overall_response == "SD", 1, 0),
    NN = if_else(overall_response == "Non-CR/Non-PD", 1, 0),
    pd_this_ta = case_when(PD == 1 ~ event_num),
    cr_this_ta = case_when(CR == 1 ~ event_num),
    pr_this_ta = case_when(PR == 1 ~ event_num),
    sd_this_ta = case_when(SD == 1 ~ event_num),
    nn_this_ta = case_when(NN == 1 ~ event_num),
    site = substr(patient, 1, 4)
  )

data_12_or_recist <- merge(
  data_02_itt,
  data_12_or_recist,
  by = "patient",
  all = FALSE
)

cols <- c(
  "CR" = "#153D99",
  "PR" = "#74AAFF",
  "SD" = "#FFD966",
  "Non-CR/Non-PD" = "#9ACEB7",
  "PD" = "#B24745"
)

shape_override <- c(23, 19, 15, 15, 4)
stroke_override <- c(1, 1, 1, .9, 1)
size_override <-  c(2, 2, 2, 2, 2)

swimmer_spider_plot <- function(site, comment, name) {
  swimmer_ta <- data_12_or_recist %>%
  filter(
    site == {{site}}
  ) %>% 
  ggplot(
    aes(y = patient, group = patient)) +
  theme_bw() + 
  theme(
    panel.grid.minor.x = element_blank(),
    panel.border = element_blank()
  ) +
  # 1 data layer: line plot showing number of TAs
  geom_line(aes(x = event_num), size = 1.5) +
  # 2 data layer: dot plot showing whether each patient had measurable disease at baseline
  geom_point(aes(x = baseline_target,
                 col = "Measurable disease"),
             size = 3.5,
             stroke = 0.75,
             shape = 13) +
  # 3 data layer: dot plot showing whether each patient had only non-measurable disease at baseline 
  geom_point(aes(x = baseline_nontarget,
                 col = "Non-measurable disease"),
             size = 3.5,
             stroke = 0.75,
             shape = 1) +
  # 4 data layer: dot plot showing TAs with an OR = SD
  geom_point(aes(x = sd_this_ta,
                 col = "SD"),
             stroke = 2,
             shape = 15) +
  # 5 data layer: dot plot showing TAs with an OR = PR
  geom_point(aes(x = pr_this_ta,
                 col = "PR"),
             size = 2,
             stroke = 1.5,
             shape = 19,
             fill = "#74AAFF") +
  # 6 data layer: dot plot showing TAs with an OR = CR
  geom_point(aes(x = cr_this_ta,
                 col = "CR"),
             size = 2,
             stroke = 1.5,
             shape = 23,
             fill = "#153D99") +
  # 7 data layer: dot plot showing TAs with an OR = PD
  geom_point(aes(x = pd_this_ta,
                 col = "PD"),
             size = 2,
             stroke = 1.5,
             shape = 4) +
  # 8 data layer: dot plot showing TAs with an OR = Non-CR/Non-PD
  geom_point(aes(x = nn_this_ta,
                 col = "Non-CR/Non-PD"),
             stroke = 2,
             shape = 15) +
  # Final aesthetics adjustments
  scale_color_manual(values = cols,
                     limits = c('CR', 'PR', 'SD', 'Non-CR/Non-PD', 'PD'),
                     name = "Overall Response") +
  scale_x_continuous(breaks = seq(1, 9, 1)) +
  guides(color = guide_legend(
    override.aes = list(
      shape = shape_override,
      stroke = stroke_override,
      size = size_override
    )
  )) +
  labs(
    x = "Tumor assessment",
    y = "Patient"
  )

  ggsave(
    paste("../output/swimmer-spider-plot/materials/", project_id, "_site-", as.character({{site}}), "_swimmer_TAs_", as.Date(Sys.Date()), ".png", sep = ""),
    swimmer_ta,
    width = 20,
    height = 20,
    units = "cm",
    dpi = 300
    )
  
  spider_ta <- data_12_or_recist %>% 
  filter(
    site == {{site}}
    ) %>%
  ggplot(
  aes(x = event_num, y = percent_change_from_baseline)
  ) + 
  # Line plot showing SDL percent change from baseline
  geom_line(aes(color = patient), size = 1.2) +
  scale_color_manual(values = c(
    rep("#000000", 200))
  ) +
  # Second data layer: dot plot showing TAs with an OR = SD
  geom_point(aes(x = sd_this_ta,
                 col = "SD"),
             stroke = 1.5,
             shape = 22,
             colour = "#FFD966",
             fill = "#FFD966") +
  # Third data layer: dot plot showing TAs with an OR = PR
  geom_point(aes(x = pr_this_ta,
                 col = "PR"),
             size = 2,
             stroke = 1.5,
             shape = 21,
             colour = "#74AAFF",
             fill = "#74AAFF") +
  # Fourth data layer: dot plot showing TAs with an OR = CR
  geom_point(aes(x = cr_this_ta,
                 col = "CR"),
             size = 2,
             stroke = 1.5,
             shape = 23,
             colour = "#153D99",
             fill = "#153D99") +
  # Fifth data layer: dot plot showing TAs with an OR = PD
  geom_point(aes(x = pd_this_ta,
                 col = "PD"),
             size = 2,
             stroke = 1.5,
             shape = 4,
             colour = "#B24745") +
  # Final aesthetics adjustments
  scale_fill_manual(values = cols,
                    name = "Overall Response") +
  theme_minimal() +
  theme(
    panel.border = element_blank(),
    panel.grid.minor.y = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.background = element_rect(fill = "#FFFFFF", colour = "#FFFFFF"),
    plot.background  = element_rect(fill = "#FFFFFF", colour = "#FFFFFF"),
    legend.title = element_text(size = 5),
    legend.text = element_text(size = 5),
    legend.justification = "top",
    legend.position = c(0.95, 0.95),
    legend.direction = "vertical"
  ) +
  labs(
    x = "Tumor assessment",
    y = "Change in SLD from baseline (%)",
    shape = "Overall response"
  ) +
  guides(size = "none",
         color = "none"
  ) +
  scale_x_continuous(breaks = seq(1, 9, 1)) +
  scale_y_continuous(breaks = seq(-100, 100 , 20))

  spider_ta <- spider_ta + scale_shape(na.translate = FALSE)
  
  ggsave(
    paste("../output/swimmer-spider-plot/materials/", project_id, "_site-", as.character({{site}}), "_spider_TAs_", as.Date(Sys.Date()), ".png", sep = ""),
    spider_ta,
    width = 15,
    height = 20,
    units = "cm",
    dpi = 300
    )

  spider_ta <- spider_ta +
    annotate("rect", xmin = 0, xmax = 9, ymin = -30, ymax = -100,
             alpha = .1,fill = "#74AAFF") +
    annotate("rect", xmin = 0, xmax = 9, ymin = 20, ymax = 100,
             alpha = .0, fill = "#B24745")
  
  combined_ta <- plot_grid(
  swimmer_ta,
  spider_ta,
  nrow = 2,
  rel_heights = c(3, 5)
  )

  title <- ggdraw() + 
    draw_label({{name}},
      fontface = 'bold',
      x = 0,
      hjust = 0
    ) +
    theme(
      plot.margin = margin(0, 0, 0, 7)
    )
  
  combined_ta <- plot_grid(
    title, combined_ta,
    ncol = 1,
    rel_heights = c(0.1, 1)
  )
    
  combined_ta <- add_sub(
    combined_ta, {{comment}},
    x = 0, hjust = 0,
    fontface = 'plain',
    size = 8
  )
  
  ggsave(
    paste("../output/swimmer-spider-plot/", project_id, "_site-", as.character({{site}}), "_TAs_", as.Date(Sys.Date()), ".png", sep = ""),
    combined_ta,
    width = 30,
    height = 75,
    units = "cm",
    dpi = 300
    )
  
  return(combined_ta)
}
```

### Quality assurance of RECIST v.1.1 evaluation

#### **Figure 2. Swimmer and spider plots of tumor assessments**

```{r site-0102-swimmer-spider-plot, message = FALSE, warning = FALSE, echo = FALSE}
site_0102_name <- "Site 0102 - Hospital Universitari i Politècnic La Fe"

comment_site_0102 <- " "

site_0102_figure <- swimmer_spider_plot("0102", comment_site_0102, site_0102_name)
grid.draw(site_0102_figure)
```

- Patient 0102-001 discontinued study treatment after 18 cycles due to unacceptable toxicity (grade 3 pneumonitis related to Pembrolizumab).

- Patient 0102-003 discontinued study treatment after 1 cycle without any post-baseline tumor assessment due to clinical progression. Please note that two empty TA pages have been created.

- Patient 0102-004 discontinued study treatment after 2 cycles due to a second primary esophageal cancer.

```{r site-0103-swimmer-spider-plot, message = FALSE, warning = FALSE, echo = FALSE}
site_0103_name <- "Site 0103 - Hospital Universitario La Paz"

comment_site_0103 <- " "

site_0103_figure <- swimmer_spider_plot("0103", comment_site_0103, site_0103_name)
grid.draw(site_0103_figure)
```

- Patient 0103-001 discontinued study treatment after 14 cycles due to radiological progression (unequivocal progression of non-target lesions).

- Patient 0103-002 is stable after 25 cycles of study treatment (last registered Lenvatinib dose: 2024-01-24; last registered Pembrolizumab dose: 2024-01-25).

```{r site-0105-swimmer-spider-plot, message = FALSE, warning = FALSE, echo = FALSE}
site_0105_name <- "Site 0105 - Hospital Clínic i Provincial de Barcelona"

comment_site_0105 <- " "

site_0105_figure <- swimmer_spider_plot("0105", comment_site_0105, site_0105_name)
grid.draw(site_0105_figure)
```

- Patient 0105-001 is stable after 30 cycles of study treatment (last registered Lenvatinib dose: 2024-01-22; last registered Pembrolizumab dose: 2024-01-23).

- Patient 0105-003 discontinued study treatment after 18 cycles due to unacceptable toxicity (grade 2 proteinuria and dyspnoea related to Pembrolizumab and grade 1 dysphonia unrelated to the study treatment).

```{r site-0201-swimmer-spider-plot, message = FALSE, warning = FALSE, echo = FALSE}
site_0201_name <- "Site 0201 - Institut Curie"

comment_site_0201 <- " "

site_0201_figure <- swimmer_spider_plot("0201", comment_site_0201, site_0201_name)
grid.draw(site_0201_figure)
```

- Patient 0201-001 is responding after 16 cycles of study treatment (last registered Lenvatinib dose: 2024-01-16; last registered Pembrolizumab dose: 2024-02-07).

- Patient 0201-002 is stable after 10 cycles of study treatment (last registered Lenvatinib dose: 2023-09-10; last registered Pembrolizumab dose: 2023-09-11).

- Patient 0201-003 is stable after 15 cycles of study treatment (last registered Lenvatinib dose: 2024-02-11; last registered Pembrolizumab dose: 2024-12-12).

- Patient 0201-004 is stable after 11 cycles of study treatment (last registered Lenvatinib dose: 2024-01-23; last registered Pembrolizumab dose: 2024-01-24).

- Patient 0201-005 discontinued study treatment after 2 cycles due to unacceptable toxicity (grade 4 myocarditis, meningoencephalite, NT-pro BNP, ECG modification, and troponin increased related to Lenvatinib).

```{r site-0202-swimmer-spider-plot, message = FALSE, warning = FALSE, echo = FALSE}
site_0202_name <- "Site 0202 - IGR Gustave Roussy"

comment_site_0202 <- " "

site_0202_figure <- swimmer_spider_plot("0202", comment_site_0202, site_0202_name)
grid.draw(site_0202_figure)
```

- Patient 0202-002 discontinued the study treatment after 2 cycles due to unacceptable toxicity (unrelated grade 4 severe sepsis on pancolitis).

- Patient 0202-003 discontinued the study treatment after after 15 cycles of study treatment due to unacceptable toxicity (**missing TEAE**).

- Patient 0202-004 is stable after 18 cycles of study treatment (last registered Lenvatinib dose: 2023-12-20; last registered Pembrolizumab dose: 2024-01-11).

- Patient 0202-005 discontinued the study treatment after 9 due to clinical progression but does not have any tumor assessment registered in the eCRF (last registered Lenvatinib dose: 2023-10-29; last registered Pembrolizumab dose: 2023-06-23).

- Patient 0202-007 is receiving the study treatment after 11 cycles but does not have any tumor assessment registered in the eCRF (last registered Lenvatinib dose: 2023-12-20; last registered Pembrolizumab dose: 2023-06-07).

- Patient 0202-008 is stable after 3 cycles of study treatment (last registered Lenvatinib dose: 2024-01-14; last registered Pembrolizumab dose: 2023-12-04).

```{r site-0203-swimmer-spider-plot, message = FALSE, warning = FALSE, echo = FALSE}
site_0203_name <- "Site 0203 - Centre Hospitalier Universitaire de Toulouse"

comment_site_0203 <- " "

site_0203_figure <- swimmer_spider_plot("0203", comment_site_0203, site_0203_name)
grid.draw(site_0203_figure)
```

- Patient 0203-001 is stable after 7 cycles of study treatment (last registered Lenvatinib dose: 2023-08-21; last registered Pembrolizumab dose: 2023-08-22).

- Patient 0203-002 is receiving the study treatment after 5 cycles but does not have any post-baseline tumor assessment yet (last registered Lenvatinib dose: 2023-09-17; last registered Pembrolizumab dose: 2023-12-06).

- Patient 0203-003 is receiving the study treatment after 1 cycle but does not have any post-baseline tumor assessment yet (last Pembrolizumab registered dose: 2023-12-05).

- Patient 0203-004 is receiving the study treatment after 1 cycle but does not have any post-baseline tumor assessment yet (last Pembrolizumab registered dose: 2024-01-03).

```{r site-0204-swimmer-spider-plot, message = FALSE, warning = FALSE, echo = FALSE}
site_0204_name <- "Site 0204 - Hôpitaux Universitaires de Marseille - Hôpital Nord"

comment_site_0204 <- " "

site_0204_figure <- swimmer_spider_plot("0204", comment_site_0204, site_0204_name)
grid.draw(site_0204_figure)
```

- Patient 0204-001 is stable after 11 cycles of study treatment (last registered Lenvatinib dose: 2023-12-27; last registered Pembrolizumab dose: 2024-01-17).

- Patient 0204-003 is stable after 3 cycles of study treatment (last registered Lenvatinib dose: 2023-12-06; last registered Pembrolizumab dose: 2023-12-07).

```{r site-0205-swimmer-spider-plot, message = FALSE, warning = FALSE, echo = FALSE}
site_0205_name <- "Site 0205 - Institut Bergonié"

comment_site_0205 <- " "

site_0205_figure <- swimmer_spider_plot("0205", comment_site_0205, site_0205_name)
grid.draw(site_0205_figure)
```

- Patient 0205-001 is responding after 12 cycles of study treatment (last registered Lenvatinib dose: 2024-01-02; last registered Pembrolizumab dose: 2024-01-23).

- Patient 0205-002 is receiving the study treatment after 1 cycle but does not have any post-baseline tumor assessment yet (last registered Lenvatinib dose: 2024-01-30; last registered Pembrolizumab dose: 2024-01-31).

```{r site-0206-swimmer-spider-plot, message = FALSE, warning = FALSE, echo = FALSE}
site_0206_name <- "Site 0206 - CLCC Oscar Lambret"

comment_site_0206 <- " "

site_0206_figure <- swimmer_spider_plot("0206", comment_site_0206, site_0206_name)
grid.draw(site_0206_figure)
```

- Patient 0206-001 is responding after 11 cycles of study treatment (last registered Lenvatinib dose: 2024-02-06; last registered Pembrolizumab dose: 2024-02-07).

- Patient 0206-002 discontinued study treatment after 7 cycles due to radiological progression (new lesions in the spleen). Please note that the **EoT page has not been created** yet.

```{r site-0301-swimmer-spider-plot, fig.height = 10, message = FALSE, warning = FALSE, echo = FALSE}
site_0301_name <- "Site 0301 - A.O.U. San Luigi Gonzaga"

comment_site_0301 <- " "

site_0301_figure <- swimmer_spider_plot("0301", comment_site_0301, site_0301_name)
grid.draw(site_0301_figure)
```

- Patient 0301-001 discontinued the study treatment after 11 cycles due to investigator decision.

- Patient 0301-002 discontinued the study treatment after 22 cycles due to exitus.

- Patient 0301-003 is responding after 21 cycles of study treatment (last registered Lenvatinib dose: 2023-12-21; last registered Pembrolizumab dose: 2024-02-02).

- Patient 0301-004 is stable after 20 cycles of study treatment (last registered Lenvatinib dose: 2024-02-07; last registered Pembrolizumab dose: 2024-02-08).

- Patient 0301-005 discontinued the study treatment after 10 cycles due to clinical progression.

- Patient 0301-006 is stable after 16 cycles of study treatment (last registered Lenvatinib dose: 2024-02-07; last registered Pembrolizumab dose: 2024-02-08).

- Patient 0301-007 is stable after 13 cycles of study treatment (last registered Lenvatinib dose: 2024-01-24; last registered Pembrolizumab dose: 2024-01-04).

- Patient 0301-008 is responding after 2 cycles of study treatment (last registered Lenvatinib dose: 2023-08-02; last registered Pembrolizumab dose: 2023-08-03).

- Patient 0301-009 is stable after 10 cycles of study treatment (last registered Lenvatinib dose: 2024-01-24; last registered Pembrolizumab dose: 2024-01-25).

- Patient 0301-010 is stable after 10 cycles of study treatment (last registered Lenvatinib dose: 2024-01-25; last registered Pembrolizumab dose: 2024-01-26).

- Patient 0301-011 is stable after 9 cycles of study treatment (last registered Lenvatinib dose: 2024-01-28; last registered Pembrolizumab dose: 2024-01-29).

- Patient 0301-012 discontinued the study treatment after 2 cycles due to radiological progression (46% increase of target lesions and unequivocal progression of non-target lesions).

- Patient 0301-013 is stable after 2 cycles of study treatment (last registered Lenvatinib dose: 2024-02-08; last registered Pembrolizumab dose: 2024-02-09).

- Patient 0301-014 is receiving the study treatment after 1 cycle but does not have any post-baseline tumor assessment yet (last registered Pembrolizumab dose: 2024-01-23).

# Preliminary Efficacy Analysis

### Follow-up

```{r, message = FALSE, warning = FALSE, echo = FALSE}

data_temp_eos <- data_temp_eos %>% 
  mutate(
    fu = as.numeric(eos_date - c1d1_date + 1)/(365.25/12)
  )

fu_median <- round(median(data_temp_eos$fu), digits = 1)
fu_min <- round(min(data_temp_eos$fu), digits = 1)
fu_max <- round(max(data_temp_eos$fu), digits = 1)
```

The median (range) follow-up time is: `r fu_median` months (`r fu_min`-`r fu_max`)

```{r, message = FALSE, warning = FALSE, echo = FALSE}
customize_labels <- function (p, font.title = NULL,
                              font.subtitle = NULL, font.caption = NULL,
                              font.x = NULL, font.y = NULL, font.xtickslab = NULL, font.ytickslab = NULL)
{
  original.p <- p
  if(is.ggplot(original.p)) list.plots <- list(original.p)
  else if(is.list(original.p)) list.plots <- original.p
  else stop("Can't handle an object of class ", class (original.p))
  .set_font <- function(font){
    font <- ggpubr:::.parse_font(font)
    ggtext::element_markdown (size = font$size, face = font$face, colour = font$color)
  }
  for(i in 1:length(list.plots)){
    p <- list.plots[[i]]
    if(is.ggplot(p)){
      if (!is.null(font.title)) p <- p + theme(plot.title = .set_font(font.title))
      if (!is.null(font.subtitle)) p <- p + theme(plot.subtitle = .set_font(font.subtitle))
      if (!is.null(font.caption)) p <- p + theme(plot.caption = .set_font(font.caption))
      if (!is.null(font.x)) p <- p + theme(axis.title.x = .set_font(font.x))
      if (!is.null(font.y)) p <- p + theme(axis.title.y = .set_font(font.y))
      if (!is.null(font.xtickslab)) p <- p + theme(axis.text.x = .set_font(font.xtickslab))
      if (!is.null(font.ytickslab)) p <- p + theme(axis.text.y = .set_font(font.ytickslab))
      list.plots[[i]] <- p
    }
  }
  if(is.ggplot(original.p)) list.plots[[1]]
  else list.plots
}

data_13_survival <- data_temp_eos %>% 
  # Create a new column "pfs event" that contains a 1 if the column "progression" is not NA and a 0 otherwise
  mutate(pfs_event = if_else(
    is.na(progression), 0, 1)) %>%
  # Create a new column "pfs" that contains the number of days between the study treatment start date and the date of progression
  mutate(pfs = if_else(
    is.na(progression), eos_date - c1d1_date, progression - c1d1_date)) %>%
  mutate(pfs = if_else(
    patient == "0202-005", discontinuation_date - c1d1_date, pfs)) %>%
  # Create a new column "os event" that contains a 1 if the column "exitus" is not NA and a 0 otherwise
  mutate(os_event = if_else(
    is.na(exitus), 0, 1)) %>%
  # Create a new column "os" that contains the number of days between the study treatment start date and the date of end of study
  mutate(os = if_else(
    is.na(exitus), eos_date - c1d1_date, exitus - c1d1_date)) %>%
  select(
    patient, pfs_event, pfs, os_event, os
  ) %>%
  mutate(pfs_event = if_else(
    pfs_event == 0 & os_event == 1, 1, pfs_event)) %>% 
  ### Manually add clinical progressions as PD events ### ---------------------
  mutate(
    pfs_event = if_else(patient == "0202-005", 1, pfs_event)
    )

data_13_survival$pfs <- data_13_survival$pfs / 30.4375
data_13_survival$os <- data_13_survival$os / 30.4375
```

## Primary Endpoint: 5-month Progression-Free Survival (PFS)

#### **Table 4. Summary of PFS events:**

```{r, message = FALSE, warning = FALSE, echo = FALSE}
pfs_results <- survfit(Surv(pfs, pfs_event) ~ 1, data = data_13_survival, conf.type = "log-log")
tidy_pfs_results <- tidy(pfs_results)

formatted_pfs_results <- tidy_pfs_results %>%
  mutate(
    time = round(time, 2),
    estimate = round(estimate, 2),
    std.error = round(std.error, 2),
    conf.low = round(conf.low, 2),
    conf.high = round(conf.high, 2)
    )

rmarkdown::paged_table(formatted_pfs_results)
```

#### **Table 5. 5-month PFS:**

```{r, message = FALSE, warning = FALSE, echo = FALSE}
tbl_survfit(
  survfit(Surv(pfs, pfs_event) ~ 1, data = data_13_survival, conf.type = "log-log"),
  times = c(5),
  label_header = "**{time}-Month PFS**"
) %>%
  modify_header(label = " ")
```

#### **Figure 3. 5-month Progression-free survival (PFS) in the intention-to-treat population**

```{r 5mo-pfs-kaplan-meier-plot, message = FALSE, warning = FALSE, echo = FALSE}
pfs5 <- summary(
  survfit(Surv(pfs, pfs_event) ~ 1, data = data_13_survival, conf.type = "log-log"), times = c(5)
  )

### Plot ----------------------------------------------------------------------
pfs_5mo <- ggsurvplot(
  fit = survfit(Surv(pfs, pfs_event) ~ 1, data = data_13_survival),
  xlab = "Time since study treatment start date (months)", 
  ylab = "Progression-Free Survival",
  conf.int = FALSE,
  surv.median.line = "hv",
  xlim = c(0,18.9),
  ylim = c(0,1.009),
  censor.size = 3.5,
  size = 1,
  break.time.by = 3,
  axes.offset = FALSE,
  surv.scale = "percent",
  break.y.by = 0.20,
  risk.table = TRUE,
  fontsize = 2.5,
  ggtheme = theme_classic(),
  palette = c("#8FB2F5"),
  legend.labs = c(" "),
  legend.title = " "
)

### Modify theme --------------------------------------------------------------
pfs_5mo <- customize_labels(
  pfs_5mo,
  font.title     = c(8, "bold",  "#0a0908"),
  font.caption   = c(8, "plain", "#0a0908"),
  font.x         = c(8, "bold",  "#0a0908"),          
  font.y         = c(8, "bold",  "#0a0908"),      
  font.xtickslab = c(8, "plain", "#0a0908"),
  font.ytickslab = c(8, "plain", "#0a0908")
)

grid.draw.ggsurvplot <- function(x){
  survminer:::print.ggsurvplot(x, newpage = FALSE)
}

pfs_5mo$plot <- pfs_5mo$plot + geom_vline(xintercept = 5, linetype = "dashed", size = 0.35)

caption1 <- paste(strwrap(
  "5-month PFS is 95% (95% CI 81.5-98.7)", 90), collapse = "\n"
  )

pfs_5mo$plot <- pfs_5mo$plot + annotate(
  "text", x = 5.5, y = 0.10,
  label = caption1,
  cex = 3.5, vjust = "center", hjust = "left", fontface = 20
  )

### Save plot ---------------------------------------------------------------
ggsave(
  paste("../output/", project_id, "_5-mo_PFS_global_", as.Date(Sys.Date()), ".png", sep = ""),
  pfs_5mo,
  width = 20,
  height = 12,
  units = "cm",
  dpi = 300
  )

### Show plot --------------------------------------------------------------
pfs_5mo
```

## Overall Survival

Listing of survival data:

```{r, message = FALSE, warning = FALSE, echo = FALSE}
listing7_formatted_names <- c(
  "Patient",
  "PFS event (PD or exitus)",
  "Time to PFS event (months)",
  "OS event (exitus)",
  "Time to OS event (months)"
  )

data_13_survival_formatted <- data_13_survival %>% 
  mutate(
    pfs_event = if_else(
      pfs_event == 0, "No", "Yes"),
    os_event = if_else(
      os_event == 0, "No", "Yes"),
    pfs = round(as.numeric(pfs), digits = 1),
    os = round(as.numeric(os), digits = 1)
  ) %>% 
  set_names(listing7_formatted_names)

rmarkdown::paged_table(data_13_survival_formatted)
```

#### **Table 6. Summary of OS events:**

```{r, message = FALSE, warning = FALSE, echo = FALSE}
os_results <- survfit(Surv(os, os_event) ~ 1, data = data_13_survival, conf.type = "log-log")
tidy_os_results <- tidy(os_results)

formatted_os_results <- tidy_os_results %>%
  mutate(
    time = round(time, 2),
    estimate = round(estimate, 2),
    std.error = round(std.error, 2),
    conf.low = round(conf.low, 2),
    conf.high = round(conf.high, 2)
    )

rmarkdown::paged_table(formatted_os_results)
```

#### **Table 7. Median OS:**

```{r, message = FALSE, warning = FALSE, echo = FALSE}
tbl_survfit(
  survfit(Surv(os, os_event) ~ 1, data = data_13_survival, conf.type = "log-log"),
  probs = 0.5,
  label_header = "**Median overall survival (OS)**"
) %>%
  modify_header(label = " ")
```

#### **Table 8. 6-month OS:**

```{r, message = FALSE, warning = FALSE, echo = FALSE}
tbl_survfit(
  survfit(Surv(os, os_event) ~ 1, data = data_13_survival, conf.type = "log-log"),
  times = c(6),
  label_header = "**{time}-Month OS**"
  ) %>%
  modify_header(label = " ")
```

#### **Figure 4. Overall survival (OS) in the intention-to-treat population**

```{r ofs-kaplan-meier-plot, message = FALSE, warning = FALSE, echo = FALSE}
### Plot ----------------------------------------------------------------------
os_global <- ggsurvplot(
  fit = survfit(Surv(os, os_event) ~ 1, data = data_13_survival),
  xlab = "Time since study treatment start date (months)", 
  ylab = "Overall Survival",
  conf.int = FALSE,
  surv.median.line = "hv",
  xlim = c(0,18.9),
  ylim = c(0,1.009),
  censor.size = 3.5,
  size = 1,
  break.time.by = 3,
  axes.offset = FALSE,
  surv.scale = "percent",
  break.y.by = 0.20,
  risk.table = TRUE,
  fontsize = 2.5,
  ggtheme = theme_classic(),
  palette = c("#8FB2F5"),
  legend.labs = c(" "),
  legend.title = " "
)

### Modify theme --------------------------------------------------------------
os_global <- customize_labels(
  os_global,
  font.title     = c(8, "bold",  "#0a0908"),
  font.caption   = c(8, "plain", "#0a0908"),
  font.x         = c(8, "bold",  "#0a0908"),          
  font.y         = c(8, "bold",  "#0a0908"),      
  font.xtickslab = c(8, "plain", "#0a0908"),
  font.ytickslab = c(8, "plain", "#0a0908")
)

grid.draw.ggsurvplot <- function(x){
  survminer:::print.ggsurvplot(x, newpage = FALSE)
}

caption1 <- paste(strwrap(
  "Medidan OS is 17 months (12.9 - NR). Events: 5/43 (11.6%)", 90), collapse = "\n"
  )

caption2 <- paste(strwrap(
  "12-month OS is 93.4% (95% CI 75.2-98.4)", 90), collapse = "\n"
  )

os_global$plot <- os_global$plot + annotate(
  "text", x = 0.5, y = 0.20,
  label = caption1,
  cex = 3.5, vjust = "center", hjust = "left", fontface = 20
  )

os_global$plot <- os_global$plot + annotate(
  "text", x = 0.5, y = 0.10,
  label = caption2,
  cex = 3.5, vjust = "center", hjust = "left", fontface = 20
  )

### Save plot ---------------------------------------------------------------
ggsave(
  paste("../output/", project_id, "_OS_global_", as.Date(Sys.Date()), ".png", sep = ""),
  os_global,
  width = 20,
  height = 12,
  units = "cm",
  dpi = 300
  )


### Show plot --------------------------------------------------------------
os_global
```

## Progression-Free Survival

#### **Table 9. Summary of PFS events:**

```{r, message = FALSE, warning = FALSE, echo = FALSE}
pfs_results <- survfit(Surv(pfs, pfs_event) ~ 1, data = data_13_survival, conf.type = "log-log")
tidy_pfs_results <- tidy(pfs_results)

formatted_pfs_results <- tidy_pfs_results %>%
  mutate(
    time = round(time, 2),
    estimate = round(estimate, 2),
    std.error = round(std.error, 2),
    conf.low = round(conf.low, 2),
    conf.high = round(conf.high, 2)
    )

rmarkdown::paged_table(formatted_pfs_results)
```

#### **Table 10. Median PFS:**

```{r, message = FALSE, warning = FALSE, echo = FALSE}
tbl_survfit(
  survfit(Surv(pfs, pfs_event) ~ 1, data = data_13_survival, conf.type = "log-log"),
  probs = 0.5,
  label_header = "**Median progression-free survival (PFS)**"
) %>%
  modify_header(label = " ")
```

#### **Table 11. 6- and 12-month PFS:**

```{r, message = FALSE, warning = FALSE, echo = FALSE}
tbl_survfit(
  survfit(Surv(pfs, pfs_event) ~ 1, data = data_13_survival, conf.type = "log-log"),
  times = c(6, 12),
  label_header = "**{time}-Month PFS**"
) %>%
  modify_header(label = " ")
```

#### **Figure 5. Progression-free survival (PFS) in the intention-to-treat population**

```{r pfs-kaplan-meier-plot, message = FALSE, warning = FALSE, echo = FALSE}
### Plot ----------------------------------------------------------------------
pfs_global <- ggsurvplot(
  fit = survfit(Surv(pfs, pfs_event) ~ 1, data = data_13_survival),
  xlab = "Time since study treatment start date (months)", 
  ylab = "Progression-Free Survival",
  conf.int = FALSE,
  surv.median.line = "hv",
  xlim = c(0,18.9),
  ylim = c(0,1.009),
  censor.size = 3.5,
  size = 1,
  break.time.by = 3,
  axes.offset = FALSE,
  surv.scale = "percent",
  break.y.by = 0.20,
  risk.table = TRUE,
  fontsize = 2.5,
  ggtheme = theme_classic(),
  palette = c("#8FB2F5"),
  legend.labs = c(" "),
  legend.title = " "
)

### Modify theme --------------------------------------------------------------
pfs_global <- customize_labels(
  pfs_global,
  font.title     = c(8, "bold",  "#0a0908"),
  font.caption   = c(8, "plain", "#0a0908"),
  font.x         = c(8, "bold",  "#0a0908"),          
  font.y         = c(8, "bold",  "#0a0908"),      
  font.xtickslab = c(8, "plain", "#0a0908"),
  font.ytickslab = c(8, "plain", "#0a0908")
)

grid.draw.ggsurvplot <- function(x){
  survminer:::print.ggsurvplot(x, newpage = FALSE)
}

caption1 <- paste(strwrap(
  "Medidan PFS is Not Reached (12.9 - NR). Events: 8/43 (18.6%)", 90), collapse = "\n"
  )

caption2 <- paste(strwrap(
  "12-month PFS is 76.4% (95% CI 52.9-89.2)", 90), collapse = "\n"
  )

pfs_global$plot <- pfs_global$plot + annotate(
  "text", x = 0.5, y = 0.20,
  label = caption1,
  cex = 3.5, vjust = "center", hjust = "left", fontface = 20
  )

pfs_global$plot <- pfs_global$plot + annotate(
  "text", x = 0.5, y = 0.10,
  label = caption2,
  cex = 3.5, vjust = "center", hjust = "left", fontface = 20
  )

### Save plot ---------------------------------------------------------------
ggsave(
  paste("../output/", project_id, "_PFS_global_", as.Date(Sys.Date()), ".png", sep = ""),
  pfs_global,
  width = 20,
  height = 12,
  units = "cm",
  dpi = 300
  )

### Show plot --------------------------------------------------------------
pfs_global
```

# Preliminary Safety Analysis

```{r, message = FALSE, warning = FALSE, echo = FALSE}
data_14_aes <- read_excel(
    here(paste0("data/", cutoff_date, "/", project_id, "_Adverse Events_", cutoff_date_formatted, ".xlsx")),
    sheet = "Adverse Events Table"
    ) %>% 
  clean_names() %>% 
  drop_na(adverse_event) %>% 
  rename(
    sae = "serious_seriousness_criteria",
    grade = "severity_intensity",
    relationship = "relationship_to_study_drug"
  ) %>% 
  mutate(
    start_date = dmy(start_date),
    end_date = dmy(end_date),
    sae = if_else(
      sae != "Not serious", "Yes", "No")
  ) %>% 
  select(
    patient, adverse_event, sae, grade, relationship, action_taken, start_date,
    end_date, outcome
    )

data_14_aes$adverse_event <- str_to_title(data_14_aes$adverse_event)
data_14_aes$adverse_event <- str_replace_all(data_14_aes$adverse_event, "Asat Increase", "ASAT Increase")
data_14_aes$adverse_event <- str_replace_all(data_14_aes$adverse_event, "Alat Increase", "ALAT Increase")
data_14_aes$adverse_event <- str_replace_all(data_14_aes$adverse_event, "Ggt Increase", "GGT Increase")
data_14_aes$adverse_event <- str_replace_all(data_14_aes$adverse_event, "Alp Increase", "ALP Increase")
data_14_aes$grade <- str_remove(data_14_aes$grade, "/.*")

data_14_aes <- merge(
  data_02_itt,
  data_14_aes,
  by = "patient",
  all = FALSE
)

# Create a table to show which patients have any adverse event of grade "Not aplicable"
data_14_aes_na <- data_14_aes %>% 
  filter(grade == "Not aplicable") %>% 
  select(patient, adverse_event, grade) %>% 
  distinct(patient, .keep_all = TRUE) %>% 
  group_by(grade) %>% 
  distinct(patient, .keep_all = FALSE) %>% 
  summarise(n = n())
```

There are `r data_14_aes_na$n` patients with adverse events of grade "Not aplicable":

```{r, message = FALSE, warning = FALSE, echo = FALSE}
# Filter patients with adverse events of grade "Not aplicable"
data_temp_aes_na <- data_14_aes %>% 
  filter(grade == "Not aplicable")

listing8_formatted_names <- c(
  "Patient",
  "Adverse Event (verbatim)",
  "Serious Adverse Event (SAE)",
  "Relationship to the study drug",
  "Action Taken?",
  "Start Date",
  "End Date",
  "Outcome"
  )

data_temp_aes_na_formatted <- data_temp_aes_na %>% 
  select(-grade) %>% 
  set_names(listing8_formatted_names)

rmarkdown::paged_table(data_temp_aes_na_formatted)
```

#### **Table 12. Adverse Events (AEs) by maximum severity in the ITT population:**

```{r, message = FALSE, warning = FALSE, echo = FALSE}
tbl_aes <- data_14_aes %>% 
  tbl_ae(
    id_df = data_02_itt,
    id = patient,
    ae = adverse_event,
    by = grade,
    digits = c(0, 0),
    sort = c("ae")
  ) %>% 
  add_overall() %>%
  modify_header(
    all_ae_cols() ~ "**{by}**",
    all_overall_cols() ~ "**Any grade**"
    ) %>%
  bold_labels()

tbl_aes %>%
  as_flex_table() %>%
  flextable::save_as_docx(
    path = here(paste0("output/", project_id, "_aes_table_", as.Date(Sys.Date()), ".docx"))
  )

tbl_aes
```

#### **Table 13. Serious Adverse Events (SAEs) by maximum severity in the ITT population:**

```{r, message = FALSE, warning = FALSE, echo = FALSE}
saes <- data_14_aes %>% 
  filter(sae == "Yes")

tbl_saes <- saes %>% 
  tbl_ae(
    id_df = data_02_itt,
    id = patient,
    ae = adverse_event,
    by = grade,
    digits = c(0, 0),
    sort = c("ae")
  ) %>% 
  add_overall() %>%
  modify_header(
    all_ae_cols() ~ "**{by}**",
    all_overall_cols() ~ "**Any grade**"
    ) %>%
  bold_labels()

tbl_saes %>%
  as_flex_table() %>%
  flextable::save_as_docx(
    path = here(paste0("output/", project_id, "_saes_table_", as.Date(Sys.Date()), ".docx"))
  )

tbl_saes
```

#### **Table 14. Adverse Events (AEs) that led to the permanent discontinuation of the study drug in the ITT population:**

```{r, message = FALSE, warning = FALSE, echo = FALSE}
aes_discontinuation <- data_14_aes %>% 
  filter(!str_detect(action_taken, "permanent"))

tbl_discontinuations <- aes_discontinuation %>% 
  tbl_ae(
    id_df = data_02_itt,
    id = patient,
    ae = adverse_event,
    by = grade,
    digits = c(0, 0),
    sort = c("ae")
  ) %>% 
  add_overall() %>%
  modify_header(
    all_ae_cols() ~ "**{by}**",
    all_overall_cols() ~ "**Any grade**"
    ) %>%
  bold_labels()

tbl_discontinuations %>%
  as_flex_table() %>%
  flextable::save_as_docx(
    path = here(paste0("output/", project_id, "_aes_discontinuations_table_", as.Date(Sys.Date()), ".docx"))
  )

tbl_discontinuations
```
